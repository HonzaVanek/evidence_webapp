{% extends "base.html" %}
{% load static %}

{% block title %}Koláčový graf{% endblock title %}

{% block style %}{% static "pojistenci/generate_pie_chart.css" %}{% endblock style %}

{% block content %}

<h1 class="pie-chart-title">Generování koláčového grafu</h1>
<p class="pie-chart-subtitle">
    Zde je možné zadat parametry grafu a aplikace vygeneruje obrázek.
</p>

{% if error_message %}
    <p style="color:red; text-align:center; font-weight:bold;">
        {{ error_message }}
    </p>
{% endif %}

<form id="pie-chart-form" method="post" class="pie-chart-form">
    {% csrf_token %}

    <label for="pie-chart-number">Počet položek grafu (1–10):</label>
    <input type="number"
           id="pie-chart-number"
           name="pie-chart-number"
           min="1"
           max="10"
           value="{{ prev_count|default:3 }}"
           required>

    <!-- POPISKY -->
    <label class="custom-labels-toggle">
        <input type="checkbox" id="use_labels" name="use_labels">
        Chci zadat popisky jednotlivých položek grafu
    </label>
    <div id="labels-container" style="display:none;"></div>

    <!-- HODNOTY -->
    <div id="values-container"></div>

    <!-- BARVY -->
    <label class="custom-colors-toggle">
        <input type="checkbox" id="use_custom_colors" name="use_custom_colors">
        Použít vlastní barvy částí grafu
    </label>
    <div id="colors-container" style="display:none;"></div>

    <p class="warning-p">!Součet jednotlivých položek grafu musí samozřejmě být 100!</p>

    {% if is_staff %}
        <div class="admin-controls">

            <h3>Admin funkce:</h3>

            <label>Vystouplá položka:</label>
                <select name="highlight_index">
                    <option value="">— žádná —</option>
                    {% for i in count_range %}
                        <option value="{{ i }}">{{ i|add:1 }}. položka</option>
                    {% endfor %}
                </select>

            <label>
                <input type="checkbox" name="full_outline">
                Obrys celého grafu
            </label>

        </div>
    {% endif %}

    <input type="submit" value="Generovat graf" class="pie-chart-submit">
</form>

{% if pie_chart_image_url %}
    <div id="pie-chart-result" class="pie-chart-output">
        <h2>Vygenerovaný graf:</h2>
        <img id="pie-chart-image" src="{{ pie_chart_image_url }}" alt="koláčový graf">
    </div>
{% endif %}

<script>
function smoothScrollTo(endY, duration = 1400) {
    const startY = window.scrollY;
    const distance = endY - startY;
    let startTime = null;

    function easeInOut(t) {
        return t < 0.5 
            ? 4 * t * t * t
            : 1 - Math.pow(-2 * t + 2, 3) / 2;
    }

    function step(timestamp) {
        if (!startTime) startTime = timestamp;
        const progress = timestamp - startTime;
        const percent = Math.min(progress / duration, 1);
        const eased = easeInOut(percent);

        window.scrollTo(0, startY + distance * eased);

        if (percent < 1) {
            requestAnimationFrame(step);
        }
    }

    requestAnimationFrame(step);
}

document.addEventListener("DOMContentLoaded", function () {

    const inputCount = document.getElementById("pie-chart-number");

    // =========================
    // ======  VALUES  =========
    // =========================
    const valuesContainer = document.getElementById("values-container");
    const prevValues = {{ prev_values|default:"[]"|safe }};
    let currentLabels = {{ prev_labels|default:"[]"|safe }};

    function rebuildValueInputs() {
        const count = parseInt(inputCount.value);
        valuesContainer.innerHTML = "";

        let newValues = [];

        if (prevValues.length !== count) {
            const base = Math.floor(100 / count);
            let sum = base * (count - 1);
            const last = 100 - sum;
            for (let i = 0; i < count - 1; i++) newValues.push(base);
            newValues.push(last);
        } else {
            newValues = [...prevValues];
        }

        for (let i = 0; i < count; i++) {
            const lbl = document.createElement("label");
            lbl.classList.add("value-label");
            lbl.setAttribute("data-index", i);

            const labelName =
                currentLabels[i] && currentLabels[i].trim() !== ""
                    ? currentLabels[i]
                    : `položky ${i + 1}`;

            lbl.textContent = `Hodnota ${labelName} (0–100):`;

            const inp = document.createElement("input");
            inp.type = "number";
            inp.name = "chart_values";
            inp.min = 0;
            inp.max = 100;
            inp.required = true;
            inp.value = newValues[i];

            valuesContainer.appendChild(lbl);
            valuesContainer.appendChild(inp);
        }
    }

    // =========================
    // ======  LABELS  =========
    // =========================
    const useLabels = document.getElementById("use_labels");
    const labelsContainer = document.getElementById("labels-container");
    const prevLabels = {{ prev_labels|default:"[]"|safe }};
    const prevUseLabels = {{ prev_use_labels|yesno:"true,false"|safe }};

    function rebuildLabelInputs() {
        const count = parseInt(inputCount.value);

        if (!useLabels.checked) {
            labelsContainer.style.display = "none";
            labelsContainer.innerHTML = "";
            currentLabels = [];
            rebuildValueInputs();
            return;
        }

        labelsContainer.style.display = "block";
        labelsContainer.innerHTML = "";

        currentLabels = [...prevLabels];

        for (let i = 0; i < count; i++) {
            const lbl = document.createElement("label");
            lbl.textContent = `Popisek položky ${i+1}:`;

            const inp = document.createElement("input");
            inp.type = "text";
            inp.name = "chart_labels";
            inp.value = prevLabels[i] || "";
            inp.setAttribute("data-index", i);

            // === LIVE UPDATE VALUE LABEL ===
            inp.addEventListener("input", function () {
                const idx = parseInt(this.getAttribute("data-index"));
                currentLabels[idx] = this.value;

                const valueLabel = valuesContainer.querySelector(
                    `label.value-label[data-index="${idx}"]`
                );

                if (valueLabel) {
                    const labelName =
                        this.value.trim() !== ""
                            ? this.value
                            : `položky ${idx + 1}`;

                    valueLabel.textContent = `Hodnota ${labelName} (0–100):`;
                }
            });

            labelsContainer.appendChild(lbl);
            labelsContainer.appendChild(inp);
        }
    }

    // =========================
    // ======  COLORS  =========
    // =========================
    const useCustomColors = document.getElementById("use_custom_colors");
    const colorsContainer = document.getElementById("colors-container");
    const prevColors = {{ prev_colors|default:"[]"|safe }};
    const prevUseCustom = {{ prev_use_custom|yesno:"true,false"|safe }};
    const DEFAULT_COLORS = [
        "#004289", "#5C9EAE", "#8F2D56", "#E9BA6A", "#E4E5C3",
        "#3F7CAC", "#D9BF77", "#6B4226", "#A1C181", "#F2E394"
    ];

    function rebuildColorInputs() {
        const count = parseInt(inputCount.value);

        if (!useCustomColors.checked) {
            colorsContainer.style.display = "none";
            colorsContainer.innerHTML = "";
            return;
        }

        colorsContainer.style.display = "block";
        colorsContainer.innerHTML = "";

        for (let i = 0; i < count; i++) {
            const lbl = document.createElement("label");
            lbl.textContent = `Barva ${i+1}:`;

            const inp = document.createElement("input");
            inp.type = "color";
            inp.name = "chart_colors";
            inp.value =
                prevColors[i] ||
                DEFAULT_COLORS[i] ||
                "#cccccc";

            colorsContainer.appendChild(lbl);
            colorsContainer.appendChild(inp);
        }
    }

    // =========================
    // ====== EVENTY ===========
    // =========================
    inputCount.addEventListener("input", function () {
        rebuildLabelInputs();
        rebuildValueInputs();
        rebuildColorInputs();
    });

    useLabels.addEventListener("change", function () {
        rebuildLabelInputs();
        rebuildValueInputs();
    });

    useCustomColors.addEventListener("change", rebuildColorInputs);

    // =========================
    // ==== INITIAL RENDER =====
    // =========================
    if (prevUseLabels) useLabels.checked = true;
    rebuildLabelInputs();

    rebuildValueInputs();

    if (prevUseCustom) useCustomColors.checked = true;
    rebuildColorInputs();

    // =========================
    // ==== SMOOTH SCROLL ======
    // =========================

    const form = document.getElementById("pie-chart-form");

    if (form) {
        form.addEventListener("submit", function () {
            sessionStorage.setItem("pie_chart_scroll_after_submit", "1");
        });
    }

    if (sessionStorage.getItem("pie_chart_scroll_after_submit") === "1") {

        sessionStorage.removeItem("pie_chart_scroll_after_submit");

        setTimeout(() => {
            const end = document.documentElement.scrollHeight;
            smoothScrollTo(end, 1400);
        }, 800);
    }

});
</script>


{% endblock content %}
